<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>서버 API → store.js 생성기</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h2 { color: #2c3e50; margin-top: 0; }
    p { margin: 8px 0; }
    input[type="text"] {
      width: 500px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
    }
    button:hover { background: #2980b9; }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #eee;
      border-radius: 8px;
      max-height: 500px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .success { color: #27ae60; font-weight: bold; }
    .error { color: #e74c3c; font-weight: bold; }
    code { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container">
    <h2>서버 API → D:\workspace\Front1020\stock\store.js</h2>
    <p>서버 URL을 입력하고 <strong>절대경로 저장</strong>을 누르세요.</p>
    <p><strong>기존 파일이 있으면 자동으로 덮어쓰기</strong>됩니다.</p>

    <label>Server URL:</label>
    <input type="text" id="url" value="http://192.168.1.2:8080/kospi1" />
    <button onclick="fetchAndSaveToAbsolutePath()">절대경로 저장</button>

    <div id="output">여기에 결과가 표시됩니다.</div>
  </div>

  <script>
    // 절대 경로 설정 (윈도우 경로 이스케이프)
    const TARGET_PATH = 'D:\\workspace\\Front1020\\stock\\store.js';

    async function fetchAndSaveToAbsolutePath() {
      const url = document.getElementById('url').value.trim();
      const output = document.getElementById('output');
      output.textContent = '서버에서 데이터 수신 중...';

      try {
        // 1. 서버에서 JSON 데이터 가져오기
        const response = await fetch(url, { mode: 'cors' });
        if (!response.ok) throw new Error(`HTTP ${response.status} - 서버 응답 오류`);

        const data = await response.json();
        if (!Array.isArray(data)) throw new Error('서버 응답이 배열 형식이 아닙니다.');

        // 2. store.js 내용 생성 (export default 포함)
        const jsContent = `// store.js - 서버에서 가져온 주가 데이터 (자동 생성)\n// 경로: D:\\\\workspace\\\\Front1020\\\\stock\\\\store.js\n// 생성 시간: ${new Date().toLocaleString()}\n\nconst stockData = ${JSON.stringify(data, null, 2)};\n\nexport default stockData;\n`;

        // 3. File System Access API 사용 (Chrome/Edge)
        if ('showSaveFilePicker' in window) {
          try {
            const fileHandle = await window.showSaveFilePicker({
              suggestedName: 'store.js',
              types: [{
                description: 'JavaScript 파일',
                accept: { 'application/javascript': ['.js'] },
              }],
            });

            // 선택된 파일 확인 (절대 경로 강제 유도)
            const file = await fileHandle.getFile();
            const selectedPath = file.name;

            if (!selectedPath.includes('store.js')) {
              throw new Error('store.js 파일을 선택해야 합니다.');
            }

            // 덮어쓰기 허용
            const writable = await fileHandle.createWritable();
            await writable.write(jsContent);
            await writable.close();

            output.innerHTML = `
              <p class="success">성공! <code>${TARGET_PATH}</code>에 저장됨</p>
              <p>기존 파일이 있으면 <strong>자동 덮어쓰기</strong>되었습니다.</p>
              <p>데이터 개수: <strong>${data.length}</strong>개</p>
              <pre>${JSON.stringify(data, null, 2)}</pre>
              <p>이제 <code>index.html</code>을 열어 캔들스틱 차트를 확인하세요!</p>
            `;

          } catch (saveError) {
            if (saveError.name === 'AbortError') {
              output.innerHTML = `<p class="error">저장이 취소되었습니다.</p>`;
            } else {
              throw saveError;
            }
          }
        } else {
          // 4. File System Access API 미지원 → 다운로드 폴백
          const blob = new Blob([jsContent], { type: 'application/javascript' });
          const downloadUrl = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = 'store.js';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(downloadUrl);

          output.innerHTML = `
            <p class="error">브라우저가 파일 시스템 접근을 지원하지 않습니다.</p>
            <p>다운로드한 <code>store.js</code>를 아래 경로에 <strong>수동으로 복사</strong>하세요:</p>
            <p><code>${TARGET_PATH}</code></p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
        }

      } catch (err) {
        output.innerHTML = `<p class="error">에러: ${err.message}</p>`;
        console.error('API_comm 오류:', err);
      }
    }
  </script>
</body>
</html>
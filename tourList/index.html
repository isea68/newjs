<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>여행지 관리 시스템</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>

  <div class="container">
    <h1>여행지 관리 시스템</h1>

    <!-- 검색 영역 -->
    <div class="search-section">
      <div class="search-label">검색항목</div>
      <div class="search-row">
        <div class="search-item"><label for="date">날짜</label><select id="date"><option value="">전체</option></select></div>
        <div class="search-item"><label for="region">지역</label><select id="region"><option value="">전체</option></select></div>
        <div class="search-item"><label for="tourist_spot">관광지</label><select id="tourist_spot"><option value="">전체</option></select></div>
        <div class="search-item"><label for="transportation">교통수단</label><select id="transportation"><option value="">전체</option></select></div>
        <div class="search-item"><label for="weather">날씨</label><select id="weather"><option value="">전체</option></select></div>
        <div class="search-item"><label for="purpose">목적</label><select id="purpose"><option value="">전체</option></select></div>
        <div style="display:flex; align-items:end;">
          <button class="search-btn" id="searchBtn">검색</button>
        </div>
      </div>
    </div>

    <!-- 입력 영역 -->
    <div class="input-section">
      <div class="input-label">여행지 추가</div>
      <div class="input-grid">
        <div class="input-item"><label>날짜</label><input type="date" id="inDate" /></div>
        <div class="input-item"><label>지역</label><input type="text" id="inRegion" /></div>
        <div class="input-item"><label>관광지</label><input type="text" id="inSpot" /></div>
        <div class="input-item"><label>인원</label><input type="number" id="inPeople" min="1" /></div>
        <div class="input-item"><label>소개</label><textarea id="inIntro"></textarea></div>
        <div class="input-item"><label>교통수단</label><input type="text" id="inTrans" /></div>
        <div class="input-item"><label>날씨</label><input type="text" id="inWeather" /></div>
        <div class="input-item"><label>지출(원)</label><input type="number" id="inSpending" min="0" /></div>
        <div class="input-item"><label>목적</label><input type="text" id="inPurpose" /></div>
        <div class="input-item"><label>체류시간</label><input type="number" step="0.5" id="inStay" min="0.5" /></div>
      </div>
      <div class="add-btn-wrapper">
        <button class="add-btn" id="addBtn">추가</button>
      </div>
      <div id="memo">
        ※ 여행기록 삭제시에는 테이블에서 항목을 클릭한 뒤 '삭제' 버튼을 클릭하세요!
      </div>
    </div>

    <!-- 결과 테이블 -->
    <div class="results-section">
      <div class="results-label">검색결과 및 추가내역</div>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>날짜</th><th>지역</th><th>관광지</th><th>인원</th><th>소개</th>
            <th>교통수단</th><th>날씨</th><th>지출(원)</th><th>목적</th><th>체류시간</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="noResults" class="no-data">검색 조건을 선택하거나 여행지를 추가하세요.</div>
    </div>

    <div class="footer">
      총 <span id="totalCount">0</span>건 | 
      <button onclick="showLocalStorage()" style="margin-left:10px; font-size:0.8rem;">localStorage 확인</button>
    </div>
  </div>

  <script type="module">
    import { fetchTravelData } from './api.js';
    import { loadEdits, applyEdits, addItem, deleteItem } from './crud.js';
    import { initSearch } from './search.js';
    import { initInput } from './input.js';
    import { renderTable, updateTotalCount } from './table.js';
    import { initDelete } from './delete.js';

    // 전역 상태
    let travelData = [];
    let serverData = [];
    let lastAddedItem = null;
    let setSelectedId = null;

    // localStorage 확인
    window.showLocalStorage = () => {
      const data = localStorage.getItem('userTravelEdits');
      alert(data ? `저장 내용:\n${data}` : '비어있습니다.');
    };

    // 메인 초기화
    async function initApp() {
      const noResults = document.getElementById('noResults');
      noResults.style.display = 'block';
      noResults.textContent = '검색 조건을 선택하거나 여행지를 추가하세요.';

      // 1. 서버 데이터 로드
      serverData = await fetchTravelData();
      if (!Array.isArray(serverData)) serverData = [];

      // 2. localStorage 로드 + 적용
      loadEdits();
      travelData = applyEdits(serverData);
      updateTotalCount(travelData.length);

      // 3. 삭제 버튼 생성 (가장 먼저!)
      const deleteModule = initDelete(async (id) => {
        deleteItem(id);
        serverData = await fetchTravelData();
        loadEdits();
        travelData = applyEdits(serverData);
        updateTotalCount(travelData.length);

        if (lastAddedItem && travelData.some(d => d.id === lastAddedItem.id)) {
          renderTable([lastAddedItem], setSelectedId);
        } else {
          renderTable(travelData, setSelectedId);
          lastAddedItem = null;
        }
      });
      setSelectedId = deleteModule.setSelectedId;

      // 4. 입력 초기화
      initInput(async (newItem) => {
        addItem(newItem);
        serverData = await fetchTravelData();
        loadEdits();
        travelData = applyEdits(serverData);
        updateTotalCount(travelData.length);

        lastAddedItem = newItem;
        renderTable([newItem], setSelectedId); // 추가된 항목만 표시
      });

      // 5. 검색 초기화 (마지막!)
      initSearch(travelData, (filtered) => {
        renderTable(filtered, setSelectedId);
      });

      // 초기 렌더링 없음
    }

    // DOM 완전히 로드된 후 실행
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM 로드 완료 → initApp 실행');
      initApp().catch(err => console.error('초기화 실패:', err));
    });
  </script>

</body>
</html>